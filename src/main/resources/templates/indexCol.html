<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∏–Ω–≥–∞</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .form-container {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    input[type="text"] {
      padding: 8px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      margin-left: 5px;
    }
    button:hover {
      background-color: #45a049;
    }
    .remove-btn {
      background-color: #f44336;
    }
    .remove-btn:hover {
      background-color: #da190b;
    }
    .show-all-btn {
      background-color: #2196F3;
    }
    .show-all-btn:hover {
      background-color: #0b7dda;
    }
    .chart-container {
      display: flex;
      align-items: flex-start;
      margin-bottom: 40px;
    }
    .legend-container {
      margin-right: 20px;
    }
    #pingChart, #multipleDatasetsChart {
      max-width: 90%;
      height: auto;
    }
    .legend-item {
      cursor: pointer;
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .legend-item.hidden {
      opacity: 0.5;
    }
    h2 {
      margin-top: 40px;
    }

    /* –°—Ç–∏–ª—å –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    .hidden-element {
      display: none !important;
    }
    .pause-btn.paused {
      background-color: #FF9800; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è –ø–∞—É–∑—ã */
    }
  </style>
</head>
<body>
<h1>–ì—Ä–∞—Ñ–∏–∫ –ø–∏–Ω–≥–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤</h1>

<div class="form-container">
  <label for="computerName">–ò–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞:</label>
  <input type="text" id="computerName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞" class="admin-control">
  <button onclick="addComputer()" title="–î–æ–±–∞–≤–∏—Ç—å –ü–ö –≤ —Å–ø–∏—Å–æ–∫" class="admin-control">‚ûï</button>
  <button class="remove-btn admin-control" onclick="removeComputer()" title="–£–¥–∞–ª–∏—Ç—å –ü–ö –∏–∑ —Å–ø–∏—Å–∫–∞">‚ûñ</button>
  <button onclick="clearPing()" title="–û—á–∏—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥">üóëÔ∏è</button>
  <button class="show-all-btn" onclick="showAll()" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ">üëÅÔ∏è</button>
  <button class="pause-btn" id="pauseButton" onclick="togglePause()" title="–ü–∞—É–∑–∞/–í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π">Pause Updates</button>
</div>

<div class="chart-container">
  <div class="legend-container" id="legendContainer"></div>
  <canvas id="pingChart" width="140" height="60"></canvas>
</div>

<script>
  const adminName = "[[${serverAdmin}]]";

  const currentPCName = "[[${computerName}]]";

  // console.error("adminName: " + adminName + " currentPCName: "+ currentPCName);
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
  const isAdmin = adminName.includes(currentPCName);
  function toggleAdminControls() {
    const adminControls = document.querySelectorAll('.admin-control');
    adminControls.forEach(control => {
      if (isAdmin) {
        control.classList.remove('hidden-element');
      } else {
        control.classList.add('hidden-element');
      }
    });

    // –¢–∞–∫–∂–µ —Å–∫—Ä—ã–≤–∞–µ–º label –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    const label = document.querySelector('label[for="computerName"]');
    if (label) {
      if (isAdmin) {
        label.classList.remove('hidden-element');
      } else {
        label.classList.add('hidden-element');
      }
    }
  }

  // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', function() {
    toggleAdminControls();
  });

  const ctx = document.getElementById('pingChart').getContext('2d');
  // const ctx2 = document.getElementById('multipleDatasetsChart').getContext('2d');
  const legendContainer = document.getElementById('legendContainer');
  // const legendContainer2 = document.getElementById('legendContainer2');
  let chart;
  // let chart2;
  let isPaused = false; // –§–ª–∞–≥ –¥–ª—è –ø–∞—É–∑—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  const SERVER_COLORS = {
    'doc-app': '#fc0202',
    'doc-app2': '#efaa78',
    'doc-app3': '#f1ce79',
    'doc-app4': '#d1ef75',
    'doc-app5': '#79f57b',
    'doc-app6': '#76ecb7',
    'doc-app7': '#7ac1f3',
    'doc-app8': '#769bec',
    'doc-wf1': '#8777ee',
    'doc-wf2': '#c275e8',
    'doc-test': '#eb77ef',
    'doc-send1': '#e5758a',
    'doc-send2': '#a17373',
    'ya.ru': '#6382ff',
    'sdo.gaz.ru': '#08195b'};

  function updateChart() {
    fetch('/api/ping')
            .then(response => response.json())
            .then(data => {
              if (!isPaused) {
                renderCharts(data);
              }
            })
            .catch(error => {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            });
  }

  function renderCharts(data) {
    const datasets = [];
    const labels = [];
    let maxLength = 0;

    for (const [server, times] of Object.entries(data.data)) {
      const color = SERVER_COLORS[server] || getRandomColor();
      datasets.push({
        label: server,
        data: times,
        backgroundColor: color,
        borderColor: color,
        borderWidth: 1
      });
      maxLength = Math.max(maxLength, times.length);
    }

    for (let i = 0; i < maxLength; i++) {
      labels.push(i);
    }

    // –ü–µ—Ä–≤—ã–π –≥—Ä–∞—Ñ–∏–∫: bar chart
    if (chart) {
      chart.data.labels = labels;
      chart.data.datasets = datasets;
      chart.update();
    } else {
      chart = new Chart(ctx, {
        type: 'bar',  // –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ —Å—Ç–æ–ª–±—á–∞—Ç—ã–π –≥—Ä–∞—Ñ–∏–∫
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –ª–µ–≥–µ–Ω–¥—É
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: '–í—Ä–µ–º—è –ø–∏–Ω–≥–∞ (–º—Å)'
              }
            },
            x: {
              title: {
                display: true,
                text: '–ò–∑–º–µ—Ä–µ–Ω–∏—è'
              }
            }
          }
        }
      });
    }
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –ª–µ–≥–µ–Ω–¥—É
    generateLegend(chart, legendContainer);

    // –í—Ç–æ—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫: —Ç–æ–∂–µ bar chart (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ scatter)
    const barDatasets = [];
    for (const [server, times] of Object.entries(data.data)) {
      const color = SERVER_COLORS[server] || getRandomColor();
      barDatasets.push({
        label: server,
        data: times,
        backgroundColor: color,
        borderColor: color,
        borderWidth: 1
      });
    }
  }

  function generateLegend(chart, container) {
    container.innerHTML = '';
    const ul = document.createElement('ul');
    ul.style.listStyle = 'none';
    ul.style.padding = '0';

    chart.data.datasets.forEach((dataset, index) => {
      const li = document.createElement('li');
      li.className = 'legend-item';

      const colorBox = document.createElement('span');
      colorBox.style.display = 'inline-block';
      colorBox.style.width = '20px';
      colorBox.style.height = '20px';
      colorBox.style.backgroundColor = dataset.backgroundColor;
      colorBox.style.marginRight = '10px';
      colorBox.style.border = '1px solid #000';

      const label = document.createTextNode(dataset.label);

      li.appendChild(colorBox);
      li.appendChild(label);

      li.onclick = () => {
        chart.data.datasets.forEach((_, i) => {
          const meta = chart.getDatasetMeta(i);
          meta.hidden = (i !== index); // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ, –∫—Ä–æ–º–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
        });
        chart.update();
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ª–µ–≥–µ–Ω–¥—ã
        updateAllLegendStyles(chart, container);
      };

      ul.appendChild(li);
    });

    container.appendChild(ul);
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ (–≤—Å–µ –≤–∏–¥–∏–º—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    updateAllLegendStyles(chart, container);
  }

  function updateAllLegendStyles(chart, container) {
    const lis = container.querySelectorAll('.legend-item');
    chart.data.datasets.forEach((_, index) => {
      const meta = chart.getDatasetMeta(index);
      updateLegendItemStyle(lis[index], meta.hidden);
    });
  }

  function updateLegendItemStyle(li, isHidden) {
    if (isHidden) {
      li.classList.add('hidden');
    } else {
      li.classList.remove('hidden');
    }
  }

  // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–∞—Ç–∞—Å–µ—Ç—ã –Ω–∞ –æ–±–æ–∏—Ö –≥—Ä–∞—Ñ–∏–∫–∞—Ö
  function showAll() {
    if (chart) {
      chart.data.datasets.forEach((_, i) => {
        const meta = chart.getDatasetMeta(i);
        meta.hidden = false;
      });
      chart.update();
      updateAllLegendStyles(chart, legendContainer);
    }
    // if (chart2) {
    //   chart2.data.datasets.forEach((_, i) => {
    //     const meta = chart2.getDatasetMeta(i);
    //     meta.hidden = false;
    //   });
    //   chart2.update();
    //   updateAllLegendStyles(chart2, legendContainer2);
    // }
  }

  function togglePause() {
    isPaused = !isPaused;
    const button = document.getElementById('pauseButton');
    button.textContent = isPaused ? 'Resume Updates' : 'Pause Updates';
    button.classList.toggle('paused', isPaused);
    if (!isPaused) {
      // –ü—Ä–∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º
      updateChart();
    }
  }

  function getRandomColor() {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) {
      color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
  }

  function addComputer() {
    if (!isAdmin) {
      alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏!');
      return;
    }
    const name = document.getElementById('computerName').value.trim();
    if (!name) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞!');
      return;
    }
    fetch(`/api/setPC?computerName=${name}`, {
      method: 'POST'
    })
            .then(response => {
              if (response.ok) {
                alert('–ü–ö –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                updateChart(); // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
              } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ü–ö: ' + response.statusText);
              }
            })
            .catch(error => {
              console.error('–û—à–∏–±–∫–∞:', error);
              alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞.');
            });
  }

  function removeComputer() {
    if (!isAdmin) {
      alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏!');
      return;
    }
    const name = document.getElementById('computerName').value.trim();
    if (!name) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞!');
      return;
    }
    fetch(`/api/removePC?computerName=${name}`, {
      method: 'POST'
    })
            .then(response => {
              if (response.ok) {
                alert('–ü–ö —É–¥–∞–ª—ë–Ω —É—Å–ø–µ—à–Ω–æ!');
                updateChart(); // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
              } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ü–ö: ' + response.statusText);
              }
            })
            .catch(error => {
              console.error('–û—à–∏–±–∫–∞:', error);
              alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞.');
            });
  }
  function clearPing() {
    fetch(`/api/clearAllPingData`, {
      method: 'POST'
    })
            .then(response => {
              if (response.ok) {
                alert('–î–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã!');
                updateChart(); // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
              } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç–∞–±–ª–∏—Ü—ã: ' + response.statusText);
              }
            })
            .catch(error => {
              console.error('–û—à–∏–±–∫–∞:', error);
              alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞.');
            });
  }
  setInterval(updateChart, 300000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
  updateChart(); // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
</script>
</body>
</html>
